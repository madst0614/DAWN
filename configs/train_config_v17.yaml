# DAWN v17 Training Config
# Full Vector Neurons + Soft Weighting + Excitability (SAR)
# 모든 뉴런 = 벡터, soft weighting으로 gradient flow

# Data
data:
  base_dir: /content/drive/MyDrive/data
  train_files:
    - train/wikitext_5to1_texts.pkl
  val_files:
    - val/wikitext_5to1_texts.pkl

# Model Architecture
model:
  model_version: "17.0"
  d_model: 320
  n_layers: 4
  n_heads: 4
  state_dim: 64

  # Compression 벡터 뉴런 (x → h) - v15 파라미터 매칭
  n_feature_qk: 768              # Q/K 압축용 벡터 수
  n_feature_v: 768               # V 압축용 벡터 수
  top_k_feature_qk: 64           # 64개 선택 → h_qk [B,S,64]
  top_k_feature_v: 64            # 64개 선택 → h_v [B,S,64]

  # Expansion 벡터 뉴런 (h → Q/K/V)
  n_relational: 1600             # Q/K 공유 벡터 풀 (라우팅만 분리)
  n_value: 768                   # V 확장용 벡터 풀
  top_k_relational: 64           # Q/K 각각 64개 선택 (다른 라우팅)
  top_k_value: 64                # 64개 선택 → h_v [B,S,64]

  # Knowledge 뉴런
  n_knowledge: 80
  coarse_k: 20
  fine_k: 10
  knowledge_rank: 128

  max_seq_len: 128
  dropout: 0.1

  # Router settings
  d_space: 64
  router_dropout: 0.1
  use_ssm_context: true
  gradient_checkpointing: false

# Training
training:
  batch_size: 128
  num_epochs: 30
  lr: 0.0003
  weight_decay: 0.1
  warmup_epochs: 2

  # Regularization
  orthogonality_weight: 0.0      # v17: 벡터라서 불필요
  diversity_weight: 0.1
  load_balance_weight: 0.03      # aux_loss coefficient
  entropy_weight: 0.0
  process_norm_weight: 0.0

use_amp: true
checkpoint_dir: /content/drive/MyDrive/dawn/checkpoints_v17
log_dir: /content/drive/MyDrive/dawn/logs_v17

# v17 Changes from v16:
#   - 모든 뉴런 벡터화 (rank 매트릭스 제거)
#   - Relational 뉴런 Q/K 공유: 풀은 하나, 라우팅은 분리 (v15 방식)
#   - Soft weighting: top-k 후 softmax로 gradient flow
#   - Excitability (SAR) 유지: τ=1.5, weight decay 적용
#
# 파라미터:
#   feature_qk:  768 × 320 = 246K
#   feature_v:   768 × 320 = 246K
#   relational: 1600 × 320 = 512K (Q/K 공유)
#   value:       768 × 320 = 246K
#   총: 1,250K
